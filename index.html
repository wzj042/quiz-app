<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>刷题</title>
    <meta name="referrer" content="no-referrer">
    <link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/KaTeX/0.15.2/katex.min.css">
    <script defer src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/KaTeX/0.15.2/katex.min.js"></script>
    <script defer src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/KaTeX/0.15.2/contrib/auto-render.min.js"></script>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vue/3.2.23/vue.global.prod.min.js"></script>
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/marked/4.0.2/marked.min.js"></script>
    <link rel="stylesheet" href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/mobile.css?v=_timestamp_">
    <link rel="icon" href="favicon.ico?v=_timestamp_" type="image/x-icon">

</head>
<body>
<div id="app" class="container">
    <!-- 未保存修改的模态窗口 -->
    <div v-if="showUnsavedModal" 
         class="modal-overlay" 
         @click.self="closeUnsavedModal"
         role="dialog"
         aria-labelledby="unsaved-modal-title"
         aria-modal="true"
         @keydown.esc="closeUnsavedModal">
        <div class="modal-content" tabindex="-1">
            <h3 id="unsaved-modal-title">未导出的修改</h3>
            <div class="modal-body">
                <p>当前题库有未导出的修改：</p>
                <div class="modified-questions-list" role="list">
                    <ul>
                        <li v-for="q in groupedModifiedQuestions" 
                            :key="q.uniqueId"
                            role="listitem">
                            题目ID: {{ q.uniqueId }}
                            <br>
                            <span class="question-preview">{{ truncateText(q.content, 50) }}</span>
                        </li>
                    </ul>
                </div>
                <div class="modal-actions">
                    <div class="modal-actions">
                        <div class="action-buttons">
                            <button class="btn export-btn" 
                                    @click="exportModifiedData"
                                    data-shortcut="Ctrl+S">
                                导出修改
                            </button>
                            <button class="btn close-btn" 
                                    @click="closeUnsavedModalAndContinue"
                                    data-shortcut="Esc">
                                直接退出
                            </button>
                        </div>
                        <label class="dont-show-again">
                            <input type="checkbox" 
                                   v-model="dontShowExportReminder"
                                   @keydown.enter="$event.target.click()">
                            <span>不再提醒</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 导航栏 -->
    <nav class="nav" role="navigation">
        <a href="#" 
           class="nav-title-link" 
           @click="goHome" 
           @mouseover="hoverTitle = true" 
           @mouseout="hoverTitle = false">
            <span class="nav-title">Quiz App</span>
        </a>
        <a href="https://github.com/wzj042/quiz-app" 
           class="github-link" 
           target="_blank" 
           rel="noopener noreferrer" 
           aria-label="在 GitHub 上查看项目"
           title="项目调试中，欢迎参与开发和反馈。可参考 demo.json 格式，Fork 项目后添加自己的题库。">
            <svg class="github-icon" viewBox="0 0 16 16" width="24" height="24" aria-hidden="true">
                <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
            </svg>
        </a>
    </nav>

    <!-- 列出题库 -->
    <div v-if="isLoading" class="card" role="status">
        <p>正在处理，请稍后...</p>
    </div>

    <template v-else>
        <div v-if="pageState === 'home'" class="card">
            <h1 class="title">
                选择题库
                <span class="update-time" v-if="updateTime">更新于: {{ formatUpdateTime(updateTime) }}</span>
            </h1>

            <!-- 总体统计 -->
            <div class="overall-stats" role="region" aria-label="总体统计">
                <h2 class="stats-title">总体统计</h2>
                <div class="stats-grid">
                    <div class="stats-item">
                        <div class="stats-value">{{ totalStats.completedQuestions }}/{{ totalStats.totalAttempts }}</div>
                        <div class="stats-label">总练习题数</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-value">{{ totalStats.averageAccuracy }}%</div>
                        <div class="stats-label">平均正确率</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-value">{{ totalStats.todayPracticed }}</div>
                        <div class="stats-label">今日已练习</div>
                    </div>
                </div>
                <button class="cross-practice-btn" @click="showCrossPracticeModal = true">
                    <i class="fas fa-random"></i>
                    跨卷练习设置
                </button>
            </div>

            <!-- 题库列表 -->
            <template v-if="fileList.length > 0">
                <ul class="horizontal-list" role="list">
                    <!-- Tags筛选器 -->
                    <div class="tags-filter" role="region" aria-label="标签筛选">
                        <div class="top-tags">
                            <button v-for="tag in topTags" 
                                    :key="tag.tag"
                                    :class="['tag-chip', { active: selectedTags.includes(tag.tag) }]"
                                    @click="toggleTag(tag.tag)"
                                    :aria-pressed="selectedTags.includes(tag.tag)"
                                    :aria-label="'选择标签: ' + tag.tag">
                                {{ tag.tag }}
                                <span v-if="selectedTags.includes(tag.tag)" class="tag-count">({{ tag.count }})</span>
                            </button>
                        </div>
                        <button :class="['tags-button', { 'has-active': selectedTags.length > 0 }]" 
                                @click="showTagsModal = true"
                                aria-label="更多标签"
                                data-shortcut="T">
                            <i class="fas fa-tags" aria-hidden="true"></i>
                        </button>
                    </div>

                    <template v-for="(group, groupIndex) in filteredGroupedFileList" :key="groupIndex">
                        <li class="category-header" role="separator">
                            <h2>{{ group[0] }}</h2>
                            <hr>
                        </li>
                        <li v-for="(fileObj, idx) in group[1]"
                            :key="idx"
                            class="quiz-item"
                            role="button"
                            tabindex="0"
                            @click="loadJsonFile(fileObj.file)"
                            @keydown.enter="loadJsonFile(fileObj.file)"
                            @keydown.space.prevent="loadJsonFile(fileObj.file)">
                            <div class="quiz-item-content">
                                <div class="quiz-item-title">{{ fileObj.name }}</div>
                                <div class="quiz-item-tags" v-if="fileObj.tags && fileObj.tags.length">
                                    <span v-for="tag in fileObj.tags.slice(0, 3)" :key="tag" class="item-tag">
                                        {{ tag }}
                                    </span>
                                </div>
                                <div class="quiz-item-stats" v-if="bankStats[fileObj.file]">
                                    <div class="quiz-stat">
                                        完成：{{ bankStats[fileObj.file].completed }}/{{ bankStats[fileObj.file].total }}
                                    </div>
                                    <div class="quiz-stat">
                                        正确率：{{ bankStats[fileObj.file].accuracy }}%
                                    </div>
                                </div>
                            </div>
                        </li>
                    </template>
                </ul>
            </template>

            <!-- 如果列表为空 -->
            <template v-else>
                <div class="empty-state" role="status">
                    没有找到可用的题库
                </div>
            </template>
        </div>

        <!-- 题库详情页面 -->
        <div v-else-if="pageState === 'setDescription'" 
            class="card"
            @keydown.prevent="handleKeyNavigation"
            tabindex="-1">
            <h1 class="title">
                {{ chosenSet.name }}
                <div class="time-info" v-if="chosenSet.createTime || chosenSet.updateTime">
                    <div v-if="chosenSet.updateTime" class="update-time">
                        更新于：{{ formatDate(chosenSet.updateTime) }}
                    </div>
                    <div v-else-if="chosenSet.createTime" class="create-time">
                        创建于：{{ formatDate(chosenSet.createTime) }}
                    </div>
                </div>
            </h1>
            <p v-if="chosenSet.description" class="pre-wrap" v-html="renderMarkdown(chosenSet.description)"></p>
            
            <!-- 题库统计信息 -->
            <div class="set-stats">
                <div class="stats-grid">
                    <div class="stats-item" tabindex="0">
                        <div class="stats-value">{{ setStats.completedQuestions }}/{{ setStats.totalQuestions }}</div>
                        <div class="stats-label">已练习题数</div>
                    </div>
                    <div class="stats-item" tabindex="0">
                        <div class="stats-value">{{ setStats.averageAccuracy }}%</div>
                        <div class="stats-label">平均正确率</div>
                    </div>
                    <div class="stats-item" tabindex="0">
                        <div class="stats-value">{{ setStats.todayDistinctQuestions }}</div>
                        <div class="stats-label">今日练习题数</div>
                        <div class="stats-sublabel">正确: {{ setStats.todayCorrect }}</div>
                    </div>
                </div>
            </div>

            <!-- 练习模式选择 -->
            <div class="mode-selection" 
                role="group" 
                aria-label="练习模式选择">
                <button 
                    class="mode-btn" 
                    @click="enterQuizMode"
                    @keydown.enter.prevent="enterQuizMode"
                    @keydown.space.prevent="enterQuizMode"
                    @keydown.left.prevent="focusPrevButton($event)"
                    @keydown.right.prevent="focusNextButton($event)"
                    @keydown.up.prevent="focusUpButton($event)"
                    @keydown.down.prevent="focusDownButton($event)"
                    tabindex="0"
                    role="button"
                    data-nav="mode-btn">
                    全部练习
                    <span class="mode-description">按顺序练习所有题目</span>
                </button>
                <button 
                    class="mode-btn" 
                    @click="enterOrderQuizMode"
                    @keydown.enter.prevent="enterOrderQuizMode"
                    @keydown.space.prevent="enterOrderQuizMode"
                    @keydown.left.prevent="focusPrevButton($event)"
                    @keydown.right.prevent="focusNextButton($event)"
                    @keydown.up.prevent="focusUpButton($event)"
                    @keydown.down.prevent="focusDownButton($event)"
                    tabindex="0"
                    role="button"
                    data-nav="mode-btn">
                    错题练习
                    <span class="mode-description">专注于之前答错的题目</span>
                </button>
                <button 
                    class="mode-btn" 
                    @click="enterRandomQuizMode"
                    @keydown.enter.prevent="enterRandomQuizMode"
                    @keydown.space.prevent="enterRandomQuizMode"
                    @keydown.left.prevent="focusPrevButton($event)"
                    @keydown.right.prevent="focusNextButton($event)"
                    @keydown.up.prevent="focusUpButton($event)"
                    @keydown.down.prevent="focusDownButton($event)"
                    tabindex="0"
                    role="button"
                    data-nav="mode-btn">
                    随机练习
                    <span class="mode-description">随机顺序练习题目</span>
                </button>
                <button 
                    class="mode-btn" 
                    @click="enterPreviewMode"
                    @keydown.enter.prevent="enterPreviewMode"
                    @keydown.space.prevent="enterPreviewMode"
                    @keydown.left.prevent="focusPrevButton($event)"
                    @keydown.right.prevent="focusNextButton($event)"
                    @keydown.up.prevent="focusUpButton($event)"
                    @keydown.down.prevent="focusDownButton($event)"
                    tabindex="0"
                    role="button"
                    data-nav="mode-btn">
                    预览模式
                    <span class="mode-description">查看和编辑所有题目和答案</span>
                </button>
            </div>
        </div>

        <!-- 题目页面 -->
        <div v-else-if="['quiz', 'orderQuiz', 'randomQuiz'].includes(pageState)" class="card">
            <!-- 添加已提交数量显示 -->
            <div class="progress-info">
                已提交：{{ currentSessionCompleted.size }}/{{ quizList.length }}
            </div>

            <div class="question-header">
                <div class="header-row">
                    <div class="flex-center">
                        <button class="back-button" @click="backToHome">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                            返回
                        </button>
                        <span class="progress-text">
                            {{ practiceManager.currentIndex + 1 }} / {{ practiceManager.questions.length }}
                            <template v-if="chosenSet.isCrossPractice && currentQuestion">
                                · 来自：{{ currentQuestion.sourceBank }}
                            </template>
                        </span>
                    </div>
                    <div class="action-buttons">
                        <button class="action-button" @click="copyCurrentLink" title="复制当前题目链接">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                            </svg>
                            复制链接
                        </button>
                        <button class="action-button" @click="saveCurrentEdit" v-if="isEditing && questionManager.checkUnsavedChanges()" title="保存并导出修改">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                <polyline points="17 21 17 13 7 13 7 21"/>
                                <polyline points="7 3 7 8 15 8"/>
                            </svg>
                            保存并导出
                        </button>
                        <button class="action-button" @click="togglePreviewMode" v-if="isAdmin">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            {{ isPreviewMode ? '退出预览' : '预览模式' }}
                        </button>
                        <button class="action-button" @click="editCurrentQuestion" v-if="isAdmin && !isPreviewMode">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            编辑
                        </button>
                    </div>
                </div>
            </div>

            <!-- 题目内容 -->
            <div 
                v-if="!isEditing || editingField !== 'content'"
                @click="isEditing && !isPreviewMode ? enterEditMode('content', currentQuestion.content) : null"
                class="question-content"
                :class="{ 'editable': !isPreviewMode && isEditing }"
                v-html="renderedContent"
            ></div>
            <textarea
                v-else-if="editingField === 'content'"
                v-model="editingContent"
                @blur="exitEditMode"
                class="edit-textarea"
                rows="8"
            ></textarea>

            <!-- 选项 -->
            <div v-if="currentQuestion.type === 'single-choice' || currentQuestion.type === 'multiple-choice'">
                <label
                    v-for="(opt, idx) in currentQuestion.options"
                    :key="idx"
                    class="option-item"
                    :class="{
                        'green': showAnswer && (currentQuestion.type === 'single-choice' ? isCorrectOptionSingle(opt) : isCorrectOptionMulti(opt)),
                        'red': showAnswer && (currentQuestion.type === 'single-choice' ? 
                            (isChosenOptionSingle(opt) && !isCorrectOptionSingle(opt)) : 
                            (chosenAnswers.includes(opt) && !isCorrectOptionMulti(opt))),
                        'editable': !isPreviewMode
                    }"
                >
                    <input
                        :type="currentQuestion.type === 'single-choice' ? 'radio' : 'checkbox'"
                        :name="currentQuestion.type === 'single-choice' ? 'single-choice-' + currentQuestion.uniqueId : ''"
                        :value="opt"
                        :checked="currentQuestion.type === 'single-choice' ? chosenAnswer === opt : chosenAnswers.includes(opt)"
                        @change="handleOptionChange(opt, currentQuestion.type === 'single-choice')"
                        :disabled="showAnswer || isEditing || isPreviewMode"
                        class="margin-right-6"
                    >
                    <div class="option-content" v-if="!isEditing || editingField !== `option-${idx}`">
                        <strong>{{ letterMap[idx] }}. </strong>
                        <span 
                            v-html="renderMarkdownWithLatex(opt)"
                            @click="isEditing && !isPreviewMode ? enterEditMode(`option-${idx}`, opt) : null"
                        ></span>
                    </div>
                    <div v-else class="option-edit">
                        <strong>{{ letterMap[idx] }}. </strong>
                        <input
                            type="text"
                            v-model="editingContent"
                            @blur="exitEditMode"
                            class="edit-input"
                        >
                    </div>
                </label>
            </div>

            <div v-else-if="currentQuestion.type === 'short-answer'">
                <!-- 简答题 -->
                <textarea
                    v-model="shortAnswerText"
                    :disabled="showAnswer"
                    rows="4"
                    class="full-width-input"
                    placeholder="请输入你的答案"
                ></textarea>
            </div>

            <div v-else-if="currentQuestion.type === 'fill-in-blank'">
                <!-- 填空题 -->
                <div v-for="(blank, idx) in currentQuestion.blanks" :key="idx" class="fill-blank-item">
                    <label :for="'blank-'+idx">空{{idx + 1}}：</label>
                    <input
                        :id="'blank-'+idx"
                        type="text"
                        v-model="fillInAnswers[idx]"
                        :disabled="showAnswer"
                        class="medium-input"
                        :placeholder="'请填写空'+(idx+1)"
                    >
                    <span v-if="showAnswer" class="answer-info">
                        正确答案：{{ currentQuestion.correct_answer[idx] }}
                    </span>
                </div>
            </div>

            <!-- 提交答案 / 下一题 按钮 -->
            <div class="flex-gap-12">
                <button
                    type="button"
                    v-if="practiceManager?.currentIndex > 0"
                    class="btn"
                    @click="prevQuestion"
                >
                    上一题
                </button>
                <button
                    type="button"
                    v-if="!showAnswer"
                    class="btn"
                    @click="submitAnswer"
                >
                    提交答案
                </button>
                <button
                    type="button"
                    v-else
                    class="btn"
                    @click="nextQuestion"
                    :disabled="practiceManager?.currentIndex === quizList.length - 1 && isPreviewMode"
                >
                    下一题 
                </button>
            </div>

            <!-- 解析 -->
            <div v-if="showAnswer" class="analysis">
                <h3>解析</h3>
                <div 
                    v-if="(!isEditing || editingField !== 'analysis') && currentQuestion.analysis"
                    @click="isEditing && !isPreviewMode ? enterEditMode('analysis', currentQuestion.analysis) : null"
                    v-html="renderedAnalysis"
                    :class="{ 'editable': isEditing && !isPreviewMode }"
                ></div>
                <div 
                    v-if="(!isEditing || editingField !== 'analysis') && !currentQuestion.analysis"
                    @click="isEditing && !isPreviewMode ? enterEditMode('analysis', '') : null"
                    class="empty-analysis"
                    :class="{ 'editable': isEditing && !isPreviewMode }"
                >
                    点击添加解析
                </div>
                <textarea
                    v-else-if="editingField === 'analysis'"
                    v-model="editingContent"
                    @blur="exitEditMode"
                    class="edit-textarea"
                    rows="6"
                    placeholder="请输入解析内容..."
                ></textarea>
            </div>

            <p class="small-text">
                键盘：1~4 选项，空格提交/下一题，Shift+C切换解析，q/e切换上一题/下一题
            </p>
        </div>

        <!-- 5) result: 最终结果 -->
        <div v-else-if="pageState === 'result'" class="card">
            <h1 class="title">答题完成</h1>
            <p>本轮共 {{ quizList.length }} 题，已完成：{{ completedCount }}。</p>
            <button type="button" class="btn" @click="pageState = 'home'">
                返回题目选择 (空格)
            </button>
        </div>
    </template>

    <!-- Tags Modal -->
    <div v-if="showTagsModal" class="modal-overlay" @click="showTagsModal = false">
        <div class="modal-content" @click.stop>
            <h2>选择标签</h2>
            <div class="tags-grid">
                <span 
                    v-for="tagInfo in allTags" 
                    :key="tagInfo.tag"
                    :class="['tag-chip', { active: selectedTags.includes(tagInfo.tag) }]"
                    @click="toggleTag(tagInfo.tag)"
                >
                    {{ tagInfo.tag }} ({{ tagInfo.count }})
                </span>
            </div>
            <div class="modal-footer">
                <button @click="clearTags" class="btn btn-clear">清除筛选</button>
                <button @click="showTagsModal = false" class="btn btn-close">关闭窗口</button>
            </div>
        </div>
    </div>

    <!-- Cross Practice Modal -->
    <div v-if="showCrossPracticeModal" 
         class="modal-overlay" 
         @click="showCrossPracticeModal = false"
         @keydown.stop>
        <div class="modal-content cross-practice-modal" 
             @click.stop
             @keydown.left.prevent
             @keydown.right.prevent
             @keydown.up.prevent
             @keydown.down.prevent>
            <h2>跨卷练习设置</h2>
            
            <!-- 题型筛选 -->
            <div class="setting-section">
                <h3>题型筛选</h3>
                <div class="question-types">
                    <label v-for="type in questionTypes" :key="type.value" class="type-checkbox">
                        <input type="checkbox" 
                               v-model="selectedQuestionTypes" 
                               :value="type.value">
                        {{ type.label }}
                    </label>
                </div>
            </div>

            <!-- 练习模式 -->
            <div class="setting-section">
                <h3>练习模式</h3>
                <div class="practice-mode">
                    <label class="mode-radio">
                        <input type="radio" 
                               v-model="crossPracticeMode" 
                               value="random">
                        随机抽题
                    </label>
                    <label class="mode-radio">
                        <input type="radio" 
                               v-model="crossPracticeMode" 
                               value="error-rate">
                        错误率优先
                    </label>
                </div>
            </div>

            <!-- 题目数量 -->
            <div class="setting-section">
                <h3>练习题数</h3>
                <div class="question-count">
                            <input type="number" 
               :value="crossPracticeCount"
               min="1" 
               :max="maxQuestionCount"
               class="count-input"
               @input="handleQuestionInput"
               @blur="handleQuestionBlur"
               @keydown.stop
               @keydown.left.prevent
               @keydown.right.prevent
               @keydown.up.prevent
               @keydown.down.prevent
               ref="countInput">
                    <span class="max-count" :class="{ 'error': crossPracticeCount > maxQuestionCount }">
                        当前可选 {{ maxQuestionCount }} 题
                        <template v-if="crossPracticeCount > maxQuestionCount">
                            (超出限制)
                        </template>
                    </span>
                </div>
            </div>

            <!-- 参与题库及占比 -->
            <div class="setting-section">
                <h3>参与题库及占比</h3>
                <div class="bank-distribution">
                    <div v-for="bank in filteredBankDistribution" 
                         :key="bank.file" 
                         class="bank-item">
                        <div class="bank-name">{{ bank.name }}</div>
                        <div class="bank-count">
                            {{ bank.questionCount }}/{{ bank.availableQuestions }}题
                            ({{ Math.round((bank.questionCount / bank.availableQuestions) * 100) }}%)
                        </div>
                        <div class="bank-progress">
                            <div class="progress-bar" 
                                 class="progress-bar" :style="{ width: Math.round((bank.questionCount / bank.availableQuestions) * 100) + '%' }"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button @click="showCrossPracticeModal = false" 
                        class="btn btn-clear">取消</button>
                <button @click="startCrossPractice" 
                        class="btn btn-primary"
                        :disabled="!canStartCrossPractice">
                    开始练习
                </button>
            </div>
        </div>
    </div>
</div>

<script type="module" defer>
    import { app, initializeApp } from './js/modules/app.js';
    
    // Initialize the app with proper error handling
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            await initializeApp();
        } catch (error) {
            console.error('Failed to initialize the application:', error);
            // Show error to user
            const appElement = document.getElementById('app');
            if (appElement) {
                appElement.innerHTML = `
                    <div class="error-message" style="padding: 20px; color: red;">
                        <h2>应用加载失败</h2>
                        <p>抱歉，应用初始化时遇到问题。请刷新页面重试。</p>
                        <p>错误信息：${error.message}</p>
                    </div>
                `;
            }
        }
    });
</script>

</body>
</html>